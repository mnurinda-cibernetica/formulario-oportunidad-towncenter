<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario Town Center</title>
    <style>
        :root {
            --primary-color: #1a2b5e; /* Town Center dark blue */
            --secondary-color: #4d6ba9; /* Town Center light blue */
            --accent-color: #b3935c; /* Town Center gold */
            --light-color: #f5f5f5;
            --dark-color: #333333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }
       
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', Arial, sans-serif;
        }
       
        body {
            background-color: #f9f9f9;
            color: var(--dark-color);
            line-height: 1.6;
        }
       
        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 30px;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
       
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
       
        .logo {
            max-width: 200px;
            margin-bottom: 15px;
        }
       
        h1 {
            color: var(--primary-color);
            font-size: 28px;
            margin-bottom: 10px;
        }
       
        .subtitle {
            color: var(--secondary-color);
            font-size: 16px;
        }
       
        .category-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
       
        .category-btn {
            background-color: white;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 10px 20px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
       
        .category-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }
       
        .category-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
       
        .form-section {
            background-color: white;
            margin-bottom: 30px;
            border-radius: var(--radius);
        }
       
        .section-title {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            border-radius: var(--radius) var(--radius) 0 0;
            font-size: 18px;
            font-weight: 600;
        }
       
        .section-content {
            padding: 20px;
        }
       
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
            gap: 20px;
        }
       
        .form-group {
            flex: 1 1 300px;
            margin-bottom: 15px;
        }
       
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-color);
        }
       
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 16px;
            transition: border 0.3s ease;
        }
       
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }
       
        textarea {
            min-height: 150px;
            resize: vertical;
        }
       
        .readonly {
            background-color: #f5f5f5;
        }
       
        .file-upload {
            margin-top: 20px;
        }
       
        .file-upload-btn {
            display: inline-block;
            background-color: var(--secondary-color);
            color: white;
            padding: 10px 20px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
       
        .file-upload-btn:hover {
            background-color: var(--primary-color);
        }
       
        .file-upload input[type="file"] {
            display: none;
        }
       
        .submit-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: block;
            margin: 30px auto 0;
        }
       
        .submit-btn:hover {
            background-color: #9a7d4d;
        }
       
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
       
        .checkbox-container {
            display: flex;
            gap: 20px;
        }
       
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: normal;
        }
       
        .checkbox-label input {
            width: auto;
            margin-right: 8px;
        }
       
        .confirmation-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
       
        .confirmation-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--radius);
            text-align: center;
            max-width: 500px;
            box-shadow: var(--shadow);
        }
       
        .confirmation-content h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
       
        .close-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 20px;
            border-radius: var(--radius);
            cursor: pointer;
        }
       
        .close-btn:hover {
            background-color: #9a7d4d;
        }
       
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
        }
       
        .required:after {
            content: ' *';
            color: #e74c3c;
        }
       
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
       
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
       
        .status-message {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: var(--radius);
            font-weight: 500;
        }
       
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
       
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
       
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px;
                width: auto;
            }
           
            .category-selector {
                flex-direction: column;
                align-items: center;
            }
           
            .form-group {
                flex: 1 1 100%;
            }
           
            .checkbox-container {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="TownCenterLogo2.png" alt="Town Center Logo" class="logo">
            <h1>Formulario de Solicitud</h1>
            <p class="subtitle">Complete el formulario para solicitar información sobre nuestros locales disponibles</p>
        </header>
       
        <div class="category-selector">
            <button class="category-btn" onclick="selectCategory(this, 'comercial')">COMERCIAL</button>
            <button class="category-btn" onclick="selectCategory(this, 'kiosco')">KIOSCO</button>
            <button class="category-btn" onclick="selectCategory(this, 'consultorio')">CONSULTORIO</button>
            <button class="category-btn" onclick="selectCategory(this, 'oficina')">OFICINA</button>
            <button class="category-btn" onclick="selectCategory(this, 'academia')">ACADEMIA</button>
        </div>
       
        <form id="townCenterForm">
            <input type="hidden" id="categoryType" name="categoryType" value="">
           
            <div class="form-section">
                <div class="section-title">Datos del Cliente</div>
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="formDate" class="required">Fecha del Formulario:</label>
                            <input type="text" id="formDate" name="formDate" class="readonly" readonly>
                        </div>
                        <div class="form-group user-type">
                            <label class="required">Corredor o Cliente:</label>
                            <div class="checkbox-container">
                                <label class="checkbox-label">
                                    <input type="radio" name="userType" value="corredor" checked> Corredor
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="userType" value="cliente"> Cliente
                                </label>
                            </div>
                        </div>
                    </div>
                   
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contactName" class="required" id="nameLabel">Nombre del Corredor:</label>
                            <input type="text" id="contactName" name="contactName" required>
                        </div>
                        <div class="form-group">
                            <label for="contactEmail" class="required">Correo electrónico:</label>
                            <input type="email" id="contactEmail" name="contactEmail" required>
                        </div>
                    </div>
                   
                    <div class="form-row">
                        <div class="form-group">
                            <label for="phoneNumber">Teléfono fijo:</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber">
                        </div>
                        <div class="form-group">
                            <label for="mobileNumber" class="required">Celular:</label>
                            <input type="tel" id="mobileNumber" name="mobileNumber" required>
                        </div>
                    </div>
                   
                    <div id="categoryContainer" class="form-row" style="display: none;">
                        <div class="form-group">
                            <label for="category" class="required">Categoría:</label>
                            <select id="category" name="category">
                                <option value="">Seleccione una categoría</option>
                                <option value="entretenimiento">Entretenimiento</option>
                                <option value="tecnologia">Tecnología</option>
                                <option value="restaurantes">Restaurantes</option>
                                <option value="zapateria">Zapatería</option>
                                <option value="ropa_damas">Ropa de damas</option>
                                <option value="ropa_caballeros">Ropa de caballeros</option>
                                <option value="jugueteria">Juguetería</option>
                                <option value="N/A">N/A</option>
                            </select>
                        </div>
                    </div>
                   
                    <div id="specialtyContainer" class="form-row" style="display: none;">
                        <div class="form-group">
                            <label for="specialty" class="required">Especialidad:</label>
                            <input type="text" id="specialty" list="specialtyList" name="specialty" placeholder="Ingrese especialidad médica...">
                            <datalist id="specialtyList">
                                <option value="Medicina General">
                                <option value="Medicina Interna">
                                <option value="Pediatría">
                                <option value="Ginecología y Obstetricia">
                                <option value="Cirugía General">
                                <option value="Cardiología">
                                <option value="Neurología">
                                <option value="Dermatología">
                                <option value="Oftalmología">
                                <option value="Otorrinolaringología">
                                <option value="Urología">
                                <option value="Psiquiatría">
                                <option value="Traumatología y Ortopedia">
                                <option value="Anestesiología">
                                <option value="Medicina Familiar y Comunitaria">
                            </datalist>
                            <div id="specialtyError" class="error-message" style="display: none; color: #e74c3c; margin-top: 5px;">
                                La especialidad seleccionada no está habilitada para atención en consultorios. Por favor, elija una especialidad médica aceptada.
                            </div>
                        </div>
                    </div>
                   
                    <div class="form-row">
                        <div class="form-group">
                            <label for="requestedM2" class="required">Metraje (M2) solicitado:</label>
                            <input type="number" id="requestedM2" name="requestedM2" required>
                        </div>
                    </div>
                   
                    <div class="form-row">
                        <div class="form-group">
                            <label for="currentLocation">Ubicación actual (dirección completa):</label>
                            <input type="text" id="currentLocation" name="currentLocation">
                        </div>
                    </div>
                   
                    <div class="form-row">
                        <div class="form-group">
                            <label for="salesProjection">Proyección de ventas mensual:</label>
                            <input type="number" id="salesProjection" name="salesProjection" step="0.01" min="0">
                        </div>
                    </div>
                   
                    <div class="form-row">
                        <div class="form-group">
                            <label for="visitDate" class="required">Fecha de visita:</label>
                            <input type="date" id="visitDate" name="visitDate" required>
                        </div>
                    </div>
                   
                    <!-- <div id="brandVisualContainer" class="form-row">
                        <div class="form-group">
                            <label for="brandVisual">Visual de marca:</label>
                            <div class="file-upload">
                                <label for="brandVisual" class="file-upload-btn">
                                    <i class="fas fa-cloud-upload-alt"></i> Adjuntar presentación visual de la marca
                                </label>
                                <input type="file" id="brandVisual" name="brandVisual" accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.jpeg,.png">
                                <span id="fileName" style="margin-left: 10px; font-size: 14px;"></span>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>
           
            <button type="submit" class="submit-btn" id="submitBtn">Enviar Solicitud</button>
           
            <div id="statusMessage" class="status-message" style="display: none;"></div>
           
            <div id="confirmationMessage" class="confirmation-message" style="display: none;">
                <div class="confirmation-content">
                    <h3>¡Hemos recibido tu solicitud!</h3>
                    <p>Estaremos contactándote pronto para coordinar la hora de la visita en la fecha indicada.</p>
                    <button class="close-btn" onclick="hideConfirmation()">Cerrar</button>
                </div>
            </div>
        </form>
    </div>
   
    <script>
        // Mapeo de categorías a IDs de Creatio
        const categoryMapping = {
            // Tipo de local
            'comercial': '398d575a-28bd-4cfb-91ad-18da8c5b02a2',
            'consultorio': '09dff2dd-9203-4214-a610-3645515fee3e',
            'kiosco': '516127af-a4da-4f18-b6f0-758ef34397a9',
            'academia': '3169bb3c-9a6e-43d5-8110-7a68d56fd84e',
            'oficina': '484e8fed-d69d-46c8-bb63-cc95727562f1'
        };
       
        // Mapeo de categorías comerciales a IDs de Creatio
        const subCategoryMapping = {
            'entretenimiento': '9a4e51dd-bca2-4773-9643-fa2a8ea8fd9f',
            'tecnologia': '7bb1cad0-64a4-4785-a2b0-211232f2f976',
            'restaurantes': 'f21822ce-30e4-4a22-84bf-76a1e38e9dd8',
            'zapateria': '52328ade-53be-4506-93e9-f476c97bda9f',
            'ropa_damas': '7b547f0e-26dc-461c-a8dc-fa8406e08c08',
            'ropa_caballeros': '810c357f-4967-41c4-85a9-a0609eccb4a6',
            'jugueteria': '152e238c-b67f-474d-a15e-9c254f5cf2e0',
            'N/A': 'd6b0118b-083e-4cfd-9531-ee7afd710474'
        };
       
        // Mapeo de especialidades médicas a IDs de Creatio
        const specialtyMapping = {
            'Medicina General': '53c491a1-4788-4861-ad90-9770146e2afa',
            'Medicina Interna': 'd4c0fc04-f181-489d-929f-554383d1d4b1',
            'Pediatría': 'c7fc0bd8-e7d9-4057-83de-0d3a2696295a',
            'Ginecología y Obstetricia': '3c500bcc-e267-408e-a421-0c2bd6473f44',
            'Cirugía General': '10786134-6932-4416-bbbd-c1004b1d248d',
            'Cardiología': '945f4136-85bb-442b-aa51-0d490272e47f',
            'Neurología': '8724da0c-7dcc-4720-be98-943b154cf5cb',
            'Dermatología': '16a3ea67-90e2-45f0-9f45-5ed37b8581d9',
            'Oftalmología': '2a09746e-7600-4645-8c60-4df650ef9f2d',
            'Otorrinolaringología': 'b7120e2e-5bf2-4c1d-9b8f-e1614115de7e',
            'Urología': '16403914-94a9-4e2a-9f8e-b9d125babdac',
            'Psiquiatría': 'b64865e2-b089-43dc-ad2b-c49d83fcb5f4',
            'Traumatología y Ortopedia': '8537aca8-35b0-4b5f-9588-b5ab64d65622',
            'Anestesiología': '3397692c-b765-4ac6-902d-b24a17fe6145',
            'Medicina Familiar y Comunitaria': '2ff25fa4-2d96-4a37-8d9e-39c4c46c2f66'
        };

        // Mapeo de tipo de contacto (Corredor/Cliente) a IDs de Creatio
        const contactTypeMapping = {
            'cliente': '4eae7671-d6ff-4fd7-aafc-4c223a625656',
            'corredor': '41830ae5-fe67-450b-9234-2a19195dd8cb'
        };

        // Canal de venta fijo (WhatsApp)
        const salesChannelId = '70392e4b-29c7-42f3-9bba-612f34bef68f';

        // Función para obtener parámetros de la URL
        function getURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                userType: urlParams.get('userType'), // 'corredor' o 'cliente'
                contactName: urlParams.get('contactName'),
                contactEmail: urlParams.get('contactEmail'),
                mobileNumber: urlParams.get('mobileNumber'),
                requestedM2: urlParams.get('requestedM2'),
                categoryType: urlParams.get('categoryType'), // 'comercial', 'kiosco', 'consultorio', 'oficina', 'academia'
                category: urlParams.get('category'), // Para subcategorías comerciales
                specialty: urlParams.get('specialty') // Para especialidades médicas
            };
        }

        // Función para mapear los parámetros URL al formulario
        function mapURLParamsToForm() {
            const params = getURLParameters();
            
            // Mapear tipo de usuario (Corredor o Cliente)
            if (params.userType && (params.userType === 'corredor' || params.userType === 'cliente')) {
                const radioButton = document.querySelector(`input[name="userType"][value="${params.userType}"]`);
                if (radioButton) {
                    radioButton.checked = true;
                    // Actualizar el label del nombre
                    const nameLabel = document.getElementById('nameLabel');
                    nameLabel.textContent = params.userType === 'corredor' ? 'Nombre del Corredor:' : 'Nombre del Cliente:';
                }
            }
            
            // Mapear nombre del contacto
            if (params.contactName && params.contactName.trim() !== '') {
                document.getElementById('contactName').value = decodeURIComponent(params.contactName);
            }
            
            // Mapear correo electrónico
            if (params.contactEmail && params.contactEmail.trim() !== '') {
                document.getElementById('contactEmail').value = decodeURIComponent(params.contactEmail);
            }
            
            // Mapear número de celular
            if (params.mobileNumber && params.mobileNumber.trim() !== '') {
                document.getElementById('mobileNumber').value = params.mobileNumber;
            }
            
            // Mapear metraje solicitado
            if (params.requestedM2 && params.requestedM2.trim() !== '' && !isNaN(params.requestedM2)) {
                document.getElementById('requestedM2').value = params.requestedM2;
            }
            
            // Mapear tipo de categoría (comercial, kiosco, consultorio, oficina, academia)
            if (params.categoryType && ['comercial', 'kiosco', 'consultorio', 'oficina', 'academia'].includes(params.categoryType)) {
                // Buscar el botón correspondiente y hacer clic en él
                const categoryButtons = document.querySelectorAll('.category-btn');
                categoryButtons.forEach(button => {
                    if (button.getAttribute('onclick').includes(`'${params.categoryType}'`)) {
                        selectCategory(button, params.categoryType);
                    }
                });

                // Mapear subcategoría comercial si aplica
                if ((params.categoryType === 'comercial' || params.categoryType === 'kiosco') && params.category) {
                    const validCategories = ['entretenimiento', 'tecnologia', 'restaurantes', 'zapateria', 'ropa_damas', 'ropa_caballeros', 'jugueteria'];
                    if (validCategories.includes(params.category)) {
                        // Esperar un momento para que se muestre el select antes de establecer el valor
                        setTimeout(() => {
                            const categorySelect = document.getElementById('category');
                            if (categorySelect) {
                                categorySelect.value = params.category;
                            }
                        }, 100);
                    }
                }
                
                // Mapear especialidad médica si aplica
                if (params.categoryType === 'consultorio' && params.specialty) {
                    const validSpecialties = Object.keys(specialtyMapping);
                    const decodedSpecialty = decodeURIComponent(params.specialty);
                    if (validSpecialties.includes(decodedSpecialty)) {
                        // Esperar un momento para que se muestre el campo antes de establecer el valor
                        setTimeout(() => {
                            const specialtyInput = document.getElementById('specialty');
                            if (specialtyInput) {
                                specialtyInput.value = decodedSpecialty;
                            }
                        }, 100);
                    }
                }
            }
        }

        // Función para convertir fecha al formato de Creatio (ISO 8601)
        function formatDateForCreatio(dateString) {
            const date = new Date(dateString);
            return date.toISOString();
        }
       
        // Set current date on page load
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('es-PA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('formDate').value = formattedDate;
           
            // Set minimum date for visit date (today)
            const visitDateInput = document.getElementById('visitDate');
            const todayFormatted = today.toISOString().split('T')[0];
            visitDateInput.min = todayFormatted;
           
            // Set up weekends to be disabled
            setupWeekendDisable();
           
            // Setup user type radio buttons
            setupUserTypeToggle();
           
            // Setup specialty validation
            setupSpecialtyValidation();

            // Map URL parameters to form fields
            mapURLParamsToForm();
        });
       
        // Disable weekends in date picker
        function setupWeekendDisable() {
            const visitDateInput = document.getElementById('visitDate');
           
            visitDateInput.addEventListener('input', function() {
                const date = new Date(this.value);
                const day = date.getDay();
               
                // 0 is Sunday, 6 is Saturday
                if (day === 0 || day === 6) {
                    alert('Por favor seleccione un día hábil (lunes a viernes).');
                    this.value = '';
                }
            });
        }
       
        // Handle user type toggle (corredor/cliente)
        function setupUserTypeToggle() {
            const radioButtons = document.querySelectorAll('input[name="userType"]');
            const nameLabel = document.getElementById('nameLabel');
           
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'corredor') {
                        nameLabel.textContent = 'Nombre del Corredor:';
                    } else {
                        nameLabel.textContent = 'Nombre del Cliente:';
                    }
                });
            });
        }
       
        // Validate specialty field
        function setupSpecialtyValidation() {
            const specialtyField = document.getElementById('specialty');
            const specialtyError = document.getElementById('specialtyError');
            const restrictedSpecialties = ['Fisioterapia', 'Radiología', 'Farmacia'];
           
            specialtyField.addEventListener('change', function() {
                const value = this.value.trim();
               
                if (restrictedSpecialties.some(s => value.toLowerCase() === s.toLowerCase())) {
                    specialtyError.style.display = 'block';
                    this.setCustomValidity('Especialidad no permitida');
                } else {
                    specialtyError.style.display = 'none';
                    this.setCustomValidity('');
                }
            });
           
            specialtyField.addEventListener('input', function() {
                // Hide error message while typing
                specialtyError.style.display = 'none';
                this.setCustomValidity('');
            });
        }
       
        // Category selection logic
        function selectCategory(button, category) {
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
           
            // Add active class to selected button
            button.classList.add('active');
           
            // Set hidden input value
            document.getElementById('categoryType').value = category;
           
            // Show/hide fields based on category
            const categoryContainer = document.getElementById('categoryContainer');
            const specialtyContainer = document.getElementById('specialtyContainer');
            // const brandVisualContainer = document.getElementById('brandVisualContainer');
            const categorySelect = document.getElementById('category');
           
            // Reset all first
            categoryContainer.style.display = 'none';
            specialtyContainer.style.display = 'none';
            // brandVisualContainer.style.display = 'block';

            categorySelect.removeAttribute('required');
           
            // Then show appropriate fields
            if (category === 'comercial') {
                categoryContainer.style.display = 'flex';
            } else if (category === 'consultorio') {
                specialtyContainer.style.display = 'flex';
                // brandVisualContainer.style.display = 'none';
            }
        }
       
        // Show selected file name
        // document.getElementById('brandVisual').addEventListener('change', function() {
        //     const fileName = this.files[0] ? this.files[0].name : '';
        //     document.getElementById('fileName').textContent = fileName;
        // });
       
        // Show status message
        function showStatusMessage(message, isSuccess) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + (isSuccess ? 'success' : 'error');
            statusDiv.style.display = 'block';
           
            // Hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
       
        // Generate unique ID for the request
        function generateUniqueId() {
            // Opción 1: Usar crypto.randomUUID() si está disponible (más moderno)
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                const uuid = crypto.randomUUID();
                // Tomar los primeros 4 caracteres del UUID y convertir a mayúsculas
                return `OP - ${uuid.substring(0, 4).toUpperCase()}`;
            }
            
            // Opción 2: Generador manual usando timestamp + random
            const timestamp = Date.now().toString(36); // Convertir timestamp a base 36
            const randomPart = Math.random().toString(36).substring(2, 6); // 4 caracteres aleatorios
            const combined = (timestamp + randomPart).substring(0, 4).toUpperCase();
            return `OP - ${combined}`;
        }

        // Form submission handling
        document.getElementById('townCenterForm').addEventListener('submit', function(e) {
            e.preventDefault();
           
            // Validate category is selected
            const category = document.getElementById('categoryType').value;
            if (!category) {
                alert('Por favor seleccione un tipo de local (COMERCIAL, KIOSCO, CONSULTORIO, OFICINA o ACADEMIA)');
                return;
            }
           
            // Prepare data for Creatio
            const formData = new FormData(this);
            const submitBtn = document.getElementById('submitBtn');
           
            // Get values from form
            const contactName = formData.get('contactName');
            const mobileNumber = formData.get('mobileNumber');
            const requestedM2 = parseInt(formData.get('requestedM2'));
            const userType = formData.get('userType');
            const salesProjection = formData.get('salesProjection');
            const visitDate = formData.get('visitDate');
           
            // Build data object for Creatio
            const creatioData = {
                ABPNombreCliente: contactName,
                ABPName: generateUniqueId(),
                ABPMetrajeSol: requestedM2,
                ABPNumeroCelular: mobileNumber,
                ABPTipoLocal: categoryMapping[category],
                ABPTipoContacto: contactTypeMapping[userType],
                ABPCanalVenta: salesChannelId,
            };

            // Add sales projection if provided (convert to decimal)
            if (salesProjection && salesProjection.trim() !== '') {
                creatioData.ABPProyeccionVentasMes = parseFloat(salesProjection);
            }

            // Add visit date (convert to Creatio format)
            if (visitDate) {
                creatioData.ABPFechaVisita = formatDateForCreatio(visitDate);
            }
           
            // Add category/specialty if applicable
            if (category === 'comercial') {
                const selectedCategory = formData.get('category');
                if (selectedCategory && subCategoryMapping[selectedCategory]) {
                    creatioData.ABPCategoriaLocal = subCategoryMapping[selectedCategory];
                }
            } else if (category === 'consultorio') {
                const selectedSpecialty = formData.get('specialty');
                if (selectedSpecialty && specialtyMapping[selectedSpecialty]) {
                    creatioData.ABPCategoriaLocal = specialtyMapping[selectedSpecialty];
                }
            }
            else {
                creatioData.ABPCategoriaLocal = subCategoryMapping['N/A'];
            }
           
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Enviando... <div class="loader"></div>';
           
            // Debug: Log the data being sent
            console.log('Datos enviados a Creatio:', creatioData);
           
            // Send to Creatio
            fetch('https://webhooks.creatio.com/webhooks/1c6c22c6-4f10-4e08-a8b4-2db5cc3dd60b', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(creatioData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en el servidor: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Respuesta de Creatio:', data);
                showStatusMessage('✅ Datos enviados exitosamente a Creatio', true);
               
                // Show confirmation message after brief delay
                setTimeout(() => {
                    document.getElementById('confirmationMessage').style.display = 'flex';
                }, 1000);
            })
            .catch(error => {
                console.error('Error al enviar a Creatio:', error);
                showStatusMessage('✅ Datos enviados exitosamente a Creatio', false);
            })
            .finally(() => {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Enviar Solicitud';
            });
        });
       
        // Hide confirmation message
        function hideConfirmation() {
            document.getElementById('confirmationMessage').style.display = 'none';
            document.getElementById('townCenterForm').reset();
           
            // Reset category selection
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
           
            // Set current date again
            const today = new Date();
            const formattedDate = today.toLocaleDateString('es-PA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('formDate').value = formattedDate;
           
            // Hide conditional fields
            document.getElementById('categoryContainer').style.display = 'none';
            document.getElementById('specialtyContainer').style.display = 'none';
            document.getElementById('specialtyError').style.display = 'none';
           
            // Reset file input display
            document.getElementById('fileName').textContent = '';
           
            // Hide status message
            document.getElementById('statusMessage').style.display = 'none';
        }
    </script>
</body>
</html>
